#!/bin/bash
# yadm bootstrap script
# This script runs automatically after `yadm clone` or `yadm checkout`
# It sets up the environment and installs necessary dependencies

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

log_error() {
    echo -e "${RED}✗${NC} $1"
}

# Check if running on macOS
is_macos() {
    [[ "$OSTYPE" == "darwin"* ]]
}

# Check if running on Linux
is_linux() {
    [[ "$OSTYPE" == "linux-gnu"* ]]
}

echo "=========================================="
echo "  yadm Bootstrap Script"
echo "=========================================="
echo ""

# Install Homebrew on macOS if not present
if is_macos; then
    if ! command -v brew &> /dev/null; then
        log_info "Homebrew not found. Installing..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        
        # Add Homebrew to PATH
        if [[ -f "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [[ -f "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
        fi
        
        log_success "Homebrew installed"
    else
        log_success "Homebrew is installed"
    fi
fi

# Install essential tools
log_info "Checking for essential tools..."

if is_macos; then
    # Install via Homebrew
    tools=("git" "zsh" "vim" "tmux")
    for tool in "${tools[@]}"; do
        if ! command -v "$tool" &> /dev/null; then
            log_info "Installing $tool..."
            brew install "$tool" || log_warning "Failed to install $tool"
        fi
    done
elif is_linux; then
    # Install via package manager
    if command -v apt-get &> /dev/null; then
        sudo apt-get update
        sudo apt-get install -y git zsh vim tmux || log_warning "Some packages failed to install"
    elif command -v yum &> /dev/null; then
        sudo yum install -y git zsh vim tmux || log_warning "Some packages failed to install"
    elif command -v pacman &> /dev/null; then
        sudo pacman -S --noconfirm git zsh vim tmux || log_warning "Some packages failed to install"
    fi
fi

# Set up zsh as default shell (if zsh is installed)
if command -v zsh &> /dev/null; then
    current_shell=$(echo $SHELL)
    zsh_path=$(which zsh)
    
    if [[ "$current_shell" != "$zsh_path" ]]; then
        log_info "Setting zsh as default shell..."
        if is_macos; then
            if ! grep -q "$zsh_path" /etc/shells; then
                echo "$zsh_path" | sudo tee -a /etc/shells
            fi
        fi
        chsh -s "$zsh_path"
        log_success "zsh set as default shell (restart terminal to take effect)"
    fi
fi

# Install Oh My Zsh if .zshrc exists and Oh My Zsh is not installed
if [ -f "$HOME/.zshrc" ] && [ ! -d "$HOME/.oh-my-zsh" ]; then
    log_info "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
    log_success "Oh My Zsh installed"
fi

# Create necessary directories
log_info "Creating necessary directories..."
mkdir -p "$HOME/.config"
mkdir -p "$HOME/.local/bin"
mkdir -p "$HOME/.cache"
log_success "Directories created"

# Set up Python environment (if .condarc or .pythonrc exists)
if [ -f "$HOME/.condarc" ] || [ -f "$HOME/.pythonrc" ]; then
    log_info "Python configuration detected"
    if is_macos && command -v brew &> /dev/null; then
        if ! command -v python3 &> /dev/null; then
            log_info "Installing Python..."
            brew install python@3.11
        fi
    fi
fi

# Set up Node.js environment (if package.json or .npmrc exists in config)
if [ -d "$HOME/.config" ] && find "$HOME/.config" -name "package.json" -o -name ".npmrc" | grep -q .; then
    log_info "Node.js configuration detected"
    if is_macos && command -v brew &> /dev/null; then
        if ! command -v node &> /dev/null; then
            log_info "Installing Node.js..."
            brew install node
        fi
    fi
fi

# Make scripts executable
if [ -d "$HOME/.local/bin" ]; then
    log_info "Making scripts executable..."
    find "$HOME/.local/bin" -type f -name "*.sh" -exec chmod +x {} \;
    find "$HOME/.local/bin" -type f -name "*.py" -exec chmod +x {} \;
fi

log_success "Bootstrap complete!"
echo ""
echo "Next steps:"
echo "  1. Restart your terminal to apply shell changes"
echo "  2. Review your dotfiles configuration"
echo "  3. Install any additional tools you need"
echo ""
